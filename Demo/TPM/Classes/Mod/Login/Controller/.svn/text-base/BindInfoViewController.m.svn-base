//
//  BindInfoViewController.m
//  STO
//
//  Created by  rjt on 16/3/29.
//  Copyright © 2016年 JYZD. All rights reserved.
//

#import "BindInfoViewController.h"
#import "BindAllViewController.h"
#import "EFTextField.h"
#import "SendNewMobileCodeEntity.h"
#import "SetMoblieAndPasswordEntity.h"


@interface BindInfoViewController ()<PasswordViewControllerDelegate,UIAlertViewDelegate>
@property (weak, nonatomic) IBOutlet UIButton *showPwdBtn;
- (IBAction)showPwdClicked:(id)sender;
- (IBAction)confirmClicked:(id)sender;
- (IBAction)codeClicked:(id)sender;

@property (weak, nonatomic) IBOutlet UIButton *confirmBtn;

@property (weak, nonatomic) IBOutlet EFTextField *codeTextField;
@property (weak, nonatomic) IBOutlet EFTextField *pwdTextField;
@property (weak, nonatomic) IBOutlet QUPhoneTextField *phoneTextField;

@property (weak, nonatomic) IBOutlet UIButton *codeBtn;
@property (weak, nonatomic) IBOutlet UIButton *gainCodeBtn;

@property (nonatomic) int time;
@property (strong,nonatomic) NSTimer* timer;
@property (nonatomic, strong) BindAllViewController *bindAllVC;
@end

@implementation BindInfoViewController

- (void)viewDidLoad {
    self.navigationController.navigationBarHidden = NO;
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.

    self.title = @"完善个人信息";
    self.confirmBtn.layer.cornerRadius = 5;
    self.gainCodeBtn.layer.borderColor = Color_Bg_RGB(217, 217, 222).CGColor;
    self.gainCodeBtn.layer.borderWidth = 1;
    self.gainCodeBtn.layer.cornerRadius = 3;
    
    self.gainCodeBtn.layer.borderColor = Color_Bg_RGB(217, 217, 222).CGColor;
    self.gainCodeBtn.layer.borderWidth = 1;
    self.gainCodeBtn.layer.cornerRadius = 3;
}

-(void)doBack:(id)obj{
    UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"提示" message:@"您确定要放弃完善个人信息并退出登录吗？" delegate:self cancelButtonTitle:@"取消" otherButtonTitles:@"确定", nil];
    alert.tag = 1000;
    [alert show];
}

-(void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex{
    
    if (alertView.tag == 1000) {
        if (buttonIndex!=alertView.cancelButtonIndex) {
            [[UserInfoManager shareUserInfoManager] removeUser];
            [self.navigationController popViewControllerAnimated:YES];
        }

    }else{
        
       [self.navigationController pushViewController:self.bindAllVC animated:YES];
        self.codeTextField.text = @"";
        self.pwdTextField.text = @"";
    }
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

-(void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event{
    [self resignAllTextFieldFirstResponder];
}
-(void)resignAllTextFieldFirstResponder{
    [self.codeTextField resignFirstResponder];
    [self.pwdTextField resignFirstResponder];
    [self.phoneTextField resignFirstResponder];
//    [self.nickTextField resignFirstResponder];
}

- (IBAction)showPwdClicked:(id)sender {
    if(self.pwdTextField.secureTextEntry){
        [self.showPwdBtn setImage:[UIImage imageNamed:@"item_display"] forState:UIControlStateNormal];
    }else{
        [self.showPwdBtn setImage:[UIImage imageNamed:@"item_hide"] forState:UIControlStateNormal];
    }
    self.pwdTextField.secureTextEntry = !self.pwdTextField.secureTextEntry;
   
}
- (IBAction)confirmClicked:(id)sender {
    [self resignAllTextFieldFirstResponder];
    NSString *phone = [self.phoneTextField.text stringByReplacingOccurrencesOfString:@" " withString:@""];
    if (phone.length != 11) {
        [WpCommonFunction showNotifyHUDAtViewBottom:self.view withErrorMessage:@"请输入手机号"];
        return;
    }
    
    NSString *payPswordStr = self.pwdTextField.text;
    //检查密码
    if( payPswordStr.length < 6 || payPswordStr.length >18 ){
        [WpCommonFunction showNotifyHUDAtViewBottom:self.view withErrorMessage:@"请输入6-18位数字、字母，字母区分大小写"];
        return;
    }

    NSString *verifyCode = self.codeTextField.text;
    if( verifyCode.length != 6  ){
        [WpCommonFunction showNotifyHUDAtViewBottom:self.view withErrorMessage:@"请输入6位数字验证码"];
        return;
    }
    self.bindAllVC = [BindAllViewController controller];
    self.bindAllVC.phone = phone;
    self.bindAllVC.payPswordStr = payPswordStr;
    self.bindAllVC.verifyCode = verifyCode;
    self.bindAllVC.pwdDelegate = self.pwdDelegate;
   
    //发送网络请求
    [[UserInfoManager shareUserInfoManager]bindUserWithPhonenum:phone pwd:payPswordStr WithVerifyCode:verifyCode andBlock:^(ReturnValue *val, QUMock *mock, QUEntity *entity) {
        
        if (val.result && [entity isKindOfClass:[SetMoblieAndPasswordEntity class]]) {
            
            SetMoblieAndPasswordEntity *e = (SetMoblieAndPasswordEntity *)entity;
            if ([e.result isEqualToString:@"Y"]) {
                
                //增加确认弹窗
                UIAlertView *confirmAlertView = [[UIAlertView alloc] initWithTitle:@"" message:@"手机登录设置成功" delegate:self cancelButtonTitle:nil otherButtonTitles:@"确认", nil];
                [confirmAlertView show];
                
            }else{
                
                [WpCommonFunction showNotifyHUDAtViewBottom:self.view withErrorMessage:val.resultString];
            }
        }
        
    }];
    
    
    
    
    
    
    
}

- (IBAction)codeClicked:(id)sender {
    NSString *phone = [self.phoneTextField.text stringByReplacingOccurrencesOfString:@" " withString:@""];
    if (phone.length != 11) {
        [WpCommonFunction showNotifyHUDAtViewBottom:self.view withErrorMessage:@"请输入手机号"];
        return;
    }
    
    DEFINED_WEAK_SELF
    [[UserInfoManager shareUserInfoManager] getVerifyCode4BindWithPhonenum:phone andBlock:^(ReturnValue *val, QUMock *mock, QUEntity *entity) {
        if (val.result && [entity isKindOfClass:[SendNewMobileCodeEntity class]]) {
            SendNewMobileCodeEntity* e = (SendNewMobileCodeEntity*)entity;
            if([e.result isEqualToString:@"Y"]){
                _self.gainCodeBtn.enabled = NO;
                [_self.gainCodeBtn setBackgroundColor:kColorBgBtnDisabled];
                [_self.gainCodeBtn setTitle:@"60秒后重新获取" forState:UIControlStateDisabled];
                _self.time = 60;
                _self.timer = [NSTimer scheduledTimerWithTimeInterval:1.f target:self selector:@selector(ticktack) userInfo:nil repeats:YES];
                [_self.gainCodeBtn setTitleColor:kColorTextBtnDisabled forState:UIControlStateDisabled];
                [WpCommonFunction showNotifyHUDAtViewBottom:self.view withErrorMessage:@"发送成功"];
                
            }
        }
    }];
}

-(void)ticktack{
    self.time--;
    if ( self.time>0) {
        [self.gainCodeBtn setTitle:[NSString stringWithFormat:@"%d秒后重新获取",self.time] forState:UIControlStateDisabled];
    }else{
        [self.timer invalidate];
        self.timer = nil;
        self.gainCodeBtn.enabled = YES;
        self.gainCodeBtn.backgroundColor = [UIColor whiteColor];
    }
    
}


@end
