//
//  Login2ViewController.m
//  QianFangGuJie
//
//  Created by 财道 on 15/1/7.
//  Copyright (c) 2015年 余龙. All rights reserved.
//

#import "Login3ViewController.h"
#import "LoginViewController.h"
#import "checkPicEntity.h"
#import "checkPicMock.h"
#import "LoginEntity.h"
#import "LoginMock.h"
#import "UserInfoEntity.h"
#import "LoginViewController.h"
#import "WHOnceTask.h"
#import "WHTimerManager.h"

#import "GestureUtil.h"
#import "UserInfoEntity.h"
#import "UserInfoMock.h"
#import "noticeMock.h"
#import "noticeEntity.h"

#import "UserInfoManager.h"
#import "PushManager.h"

@interface Login3ViewController ()<UITextFieldDelegate>
@property (strong, nonatomic) IBOutlet UIImageView *imageHead;      //头像
@property (strong, nonatomic) IBOutlet UILabel *lblPhoneNum;        //手机号

@property (strong,nonatomic)NSString* phoneNumStr;             //本地存储的手机号
//@property (strong,nonatomic)TestParam* testParam;          //测试param

@property(strong,nonatomic)UserInfoParam* myUserInfoParam;   //用户信息param
@property(strong,nonatomic)UserInfoMock* myUserInfoMock;     //用户信息mock

@property(strong,nonatomic)noticeParam* myNoticeParam;   //站内信预处理param
@property(strong,nonatomic)noticeMock* myNoticeMock;       //站内信预处理mock
- (IBAction)switchAccount:(id)sender;


@property(assign,nonatomic)BOOL isBackLogin;                   //是否需要走登录接口
@end

@implementation Login3ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    [WpCommonFunction setView:self.imageHead cornerRadius:self.imageHead.frame.size.height/2 color:LOGIN_HEAD_GRAY.CGColor  borderWidth:3];
    
    [self loadUserInfo];
    [[NSNotificationCenter defaultCenter]addObserver:self selector:@selector(toLogin) name:kToLogin object:nil];
       // Do any additional setup after loading the view from its nib.
    
}

-(void)toLogin{
    [[ViewControllerManager sharedManager] showWaitView:self.view];
    self.mark = @"login";
    DEFINED_WEAK_SELF
    //uid登录，type=6
    [self.userinfomanager loginWithLoginID:[self.userinfomanager getUserPhonenumber] Password:self.password.text LogInType:@"6" ReturnBlock:^(ReturnValue *val, QUMock *mock, QUEntity *entity) {
        _self.loginButton.enabled=YES;
        LoginEntity* e = (LoginEntity*)entity;
        if([e.error_code isEqualToString:code2str(NET_SUCCESS_CODE)])
        {
            //初始化输入框
            [_self initTextField];
            [_self LoginSuccess:e];
            
        }
        else if ([e.error_code isEqualToString:code2str(NET_ERROR_CODE_VARIFYPIC_NEEDED) ])
        {
            [[ViewControllerManager sharedManager] hideWaitView];
            [WpCommonFunction showNotifyHUDAtViewBottom:_self.view withErrorMessage:@"密码错误"];
            _self.identifyImage.hidden = NO;                 //需要验证码
            _self.viewIdentify.hidden = NO;
            //  __block UIImage* img = nil;
            /************************************走验证码图片请求   *********************************/
            [_self getNewPic];
        }else{
            [[ViewControllerManager sharedManager] hideWaitView];
            //当验证码激活时，任何的网络请求都会刷新验证码
            if(!_self.identifyImage.isHidden){
                [_self getNewPic];
            }
        }
    }];

}

-(void)loadUserInfo{
    self.lblPhoneNum.text = [self.userinfomanager getUserPhonenumber];
//    NSString* touxiangStr = [self.userinfomanager getUserLogo];
//    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
//        NSData* data  = [NSData dataWithContentsOfURL:[NSURL URLWithString:touxiangStr]];
//        dispatch_sync(dispatch_get_main_queue(), ^{
//            if (data) {
//                self.imageHead.image = [UIImage imageWithData:data];
////                [self.userinfomanager setHeadImg:self.imageHead.image];
//            }
//        });
//    });
    [self.userinfomanager getHeadImg:self.imageHead];
    [WpCommonFunction setView:self.imageHead cornerRadius:62.f color:LOGIN_HEAD_GRAY.CGColor  borderWidth:1];      //设置背景为圆角

}


-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    [MobClick beginLogPageView:@"锁屏"];
    
    [[WHOnceTask shareOnceTask] removeTask:kLoginRepeatQuery];
    [[WHTimerManager shareTimerManager] disabledNotify:kLoginRepeatQuery];
    
    self.mobileNumberString = [WpCommonFunction stringRemoveAllWhiteSpace:self.lblPhoneNum.text];
    
    if ([self.mark isEqualToString:kSessionTimeout]) {
        [WpCommonFunction messageBoxWithMessage:@"登录超时，请重新登录"];
    }
    self.navigationController.navigationBarHidden = YES;
    

}

-(void)viewWillDisappear:(BOOL)animated{
    [super viewWillDisappear:animated];
    [MobClick endLogPageView:@"锁屏"];
}

- (void) viewDidAppear:(BOOL)animated
{
    self.navigationItem.hidesBackButton = YES;
    [super viewDidAppear:animated];
    
    //[self performSelector:@selector(popUpKeyboard) withObject:self afterDelay:DelayShowKeyBoard];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}


#pragma mark -登录成功
-(void)LoginSuccess:(LoginEntity*)e{
    
    [super LoginSuccess:e];
    [self LoginSuccessShowWithIndexController];
    
    [[PushManager sharePushManager] checkDTokenWithUid:[[UserInfoManager shareUserInfoManager] getUserID]];

}

- (IBAction)switchAccount:(id)sender {
    if ([self.pwdDelegate respondsToSelector:@selector(pwdViewControllerSwitchAccount:)]) {
        [self.pwdDelegate pwdViewControllerSwitchAccount:self];
    }
}

- (IBAction)switchForgetPwd:(id)sender {
    if ([self.pwdDelegate respondsToSelector:@selector(pwdViewControllerSwitchAccount:)]) {
        [self.pwdDelegate pwdViewControllerSwitchForgetPwd:self];
    }
}



@end

