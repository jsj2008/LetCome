//
//  Login2ViewController.m
//  QianFangGuJie
//
//  Created by 财道 on 15/1/7.
//  Copyright (c) 2015年 余龙. All rights reserved.
//

#import "Login2ViewController.h"
#import "LoginViewController.h"
#import "checkPicEntity.h"
#import "checkPicMock.h"
#import "LoginEntity.h"
#import "LoginMock.h"
#import "UserInfoEntity.h"
#import "LoginViewController.h"
#import "WHOnceTask.h"
#import "WHTimerManager.h"
#import "UserInfoManager.h"
#import "PushManager.h"

@interface Login2ViewController ()<UITextFieldDelegate>
@property (strong, nonatomic) IBOutlet UIImageView *imageHead;      //头像
@property (strong, nonatomic) IBOutlet UILabel *lblPhoneNum;        //手机号

@property (strong,nonatomic)NSString* phoneNumStr;             //本地存储的手机号
//@property (strong,nonatomic)TestParam* testParam;          //测试param

@property (weak, nonatomic) IBOutlet UIButton *switchButton; //切换账号

- (IBAction)switchAccount:(id)sender;


@property(assign,nonatomic)BOOL isBackLogin;                   //是否需要走登录接口
@end

@implementation Login2ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    [WpCommonFunction setView:self.imageHead cornerRadius:self.imageHead.frame.size.height/2 color:LOGIN_HEAD_GRAY.CGColor borderWidth:3];
     [self loadUserInfo];
    
    [[NSNotificationCenter defaultCenter]addObserver:self selector:@selector(toLogin) name:kToLogin object:nil];
       // Do any additional setup after loading the view from its nib.

    if([self.mark isEqualToString:@"GestureReset"] || [self.mark isEqualToString:@"gesture"]){
        self.backBtn.hidden = YES;
        [self.switchButton setTitle:@"返 回" forState:UIControlStateNormal];
    }else if([self.mark isEqualToString:@"passwordwindow"] && [UserInfoManager hasLogin]){
        self.backBtn.hidden = YES;
    }else{
        self.backBtn.hidden = NO;
    }
}



-(void)toLogin{
    [[ViewControllerManager sharedManager] showWaitView:self.view];
DEFINED_WEAK_SELF
    self.mark = @"login";
    //uid登录，type=6
    [self.userinfomanager loginWithLoginID:[self.userinfomanager getUserPhonenumber] Password:self.password.text LogInType:@"6" ReturnBlock:^(ReturnValue *val, QUMock *mock, QUEntity *entity) {
        _self.loginButton.enabled=YES;
        [[ViewControllerManager sharedManager] hideWaitView];
        LoginEntity* e = (LoginEntity*)entity;
        if([e.error_code isEqualToString:code2str(NET_SUCCESS_CODE)])
        {
            //初始化输入框
            [_self initTextField];
            [_self LoginSuccess:e];
        }
        else if ([e.error_code isEqualToString:code2str(NET_ERROR_CODE_VARIFYPIC_NEEDED) ])
        {
            [[ViewControllerManager sharedManager] hideWaitView];
            [WpCommonFunction showNotifyHUDAtViewBottom:_self.view withErrorMessage:@"密码错误"];
            _self.identifyImage.hidden = NO;                 //需要验证码
            _self.viewIdentify.hidden = NO;
            //  __block UIImage* img = nil;
            /************************************走验证码图片请求   *********************************/
            [_self getNewPic];
        }else{
            [[ViewControllerManager sharedManager] hideWaitView];
            //当验证码激活时，任何的网络请求都会刷新验证码
            if(!_self.identifyImage.isHidden){
                [_self getNewPic];
            }
        }
    }];
}

-(void)loadUserInfo{
    self.lblPhoneNum.text = [self.userinfomanager getUserPhonenumber];
//    NSString* touxiangStr = [self.userinfomanager getUserLogo];
//    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
//        NSData* data  = [NSData dataWithContentsOfURL:[NSURL URLWithString:touxiangStr]];
//        dispatch_sync(dispatch_get_main_queue(), ^{
//            if (data) {
//                self.imageHead.image = [UIImage imageWithData:data];
////                [self.userinfomanager setHeadImg:self.imageHead.image];
//            }
//        });
//    });
    [self.userinfomanager getHeadImg:self.imageHead];
    [WpCommonFunction setView:self.imageHead cornerRadius:62.f color:LOGIN_HEAD_GRAY.CGColor  borderWidth:1];      //设置背景为圆角

}


-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    [MobClick beginLogPageView:@"锁屏"];
    
    [[WHOnceTask shareOnceTask] removeTask:kLoginRepeatQuery];
    [[WHTimerManager shareTimerManager] disabledNotify:kLoginRepeatQuery];
    
    self.mobileNumberString = [WpCommonFunction stringRemoveAllWhiteSpace:self.lblPhoneNum.text];
    
    if ([self.mark isEqualToString:kSessionTimeout]) {
        [WpCommonFunction messageBoxWithMessage:@"登录超时，请重新登录"];
    }
    self.navigationController.navigationBarHidden = YES;
    

}

-(void)viewWillDisappear:(BOOL)animated{
    [super viewWillDisappear:animated];
    [MobClick endLogPageView:@"锁屏"];
}

- (void) viewDidAppear:(BOOL)animated
{
    self.navigationItem.hidesBackButton = YES;
    [super viewDidAppear:animated];
    
    //[self performSelector:@selector(popUpKeyboard) withObject:self afterDelay:DelayShowKeyBoard];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

#pragma mark -登录成功
-(void)LoginSuccess:(LoginEntity*)e{
    [super LoginSuccess:e];
    if ([self.mark isEqualToString:@"login"]) {
//        for (MyViewController* controller in self.navigationController.childViewControllers) {
//            if ([controller isKindOfClass:[IndexViewController class]]) {
//                [self.navigationController popToViewController:controller animated:YES];
//            }
//        }
    }else if ([self.mark isEqualToString:@"gesture"]) {
        [self.gesture loginCallback:YES];
        [self dismissViewControllerAnimated:YES completion:nil];
    }else if ([self.mark isEqualToString:@"passwordwindow"]) {

        [[ViewControllerManager sharedManager] hideWaitView];
        [self performSelector:@selector(gotoBack) withObject:nil afterDelay:.7f];

    }else if([self.mark isEqualToString:@"GestureReset"]){
        [self.resetGestureDelegate resetGesture];
        [self dismissViewControllerAnimated:YES completion:nil];
    }else{
        [[ViewControllerManager sharedManager] hideWaitView];
        
        [self performSelector:@selector(popBack) withObject:nil afterDelay:.7f];
    }
}

-(void) gotoBack{
    if (self.pwdDelegate && [self.pwdDelegate respondsToSelector:@selector(pwdViewControllerUnlocked:)]) {
        [self.pwdDelegate pwdViewControllerUnlocked:self];
    }
}


-(void) popBack{
    [self gotoBack];
    [UIView transitionWithView:self.navigationController.view duration:0.5 options:UIViewAnimationOptionTransitionCrossDissolve animations:^{
        [self.navigationController popViewControllerAnimated:NO];
    } completion:^(BOOL finished) {
        
    }];
}


- (IBAction)switchAccount:(id)sender {
    if ([self.mark isEqualToString:@"GestureReset"] || [self.mark isEqualToString:@"gesture"]) {
        [self dismissViewControllerAnimated:YES completion:nil];
    }else{
        [self initTextField];
        [self.userinfomanager removeUser];
        if (self.pwdDelegate && [self.pwdDelegate respondsToSelector:@selector(pwdViewControllerSwitchAccount:)]) {
           [self.pwdDelegate pwdViewControllerSwitchAccount:self];
        }else{
            [self.navigationController popToRootViewControllerAnimated:NO];
            [AppUtil exitAccount:NO];
        }
    }
}

-(void)forgetClicked:(id)sender{
    [self initTextField];
    [self.userinfomanager removeUser];
    if (self.pwdDelegate && [self.pwdDelegate respondsToSelector:@selector(pwdViewControllerSwitchForgetPwd:)]) {
        [self.pwdDelegate pwdViewControllerSwitchForgetPwd:self];
    }else{
        [self.navigationController popToRootViewControllerAnimated:YES];
        [getUserInfoManager removeUser];
        [AppUtil switchIndex:NO];
        [[PasswordWindow shareWindow] showWithLogin];
    }
}
@end

