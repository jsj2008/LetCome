//
//  ForgetViewController.m
//  QianFangGuJie
//
//  Created by 李荣 on 15/3/23.
//  Copyright (c) 2015年 余龙. All rights reserved.
//

#import "ForgetViewController.h"
#import "WHOnceTask.h"
#import "EFTextField.h"
#import "UidMobileCodeCheckMock.h"
#import "UidMobileCodeCheckEntity.h"
#import "ResetViewController.h"
#import "NetResultCode.h"
#import "UserInfoManager.h"
#import "SendUidMobileCodeEntity.h"
#import "UidMobileCodeCheckEntity.h"

#define Color_Bg_blue Color_Bg_RGB(80.0f, 140.0f, 240.0f)
#define Color_Bg_White Color_Bg_RGB(255.0f, 255.0f, 255.0f)

typedef enum {
    kMobilePhoneTextFieldTag = 10000,
    kMobileCodeTextFieldTag = 10001,
    kMobilePicTextFieldTag = 10002
}TextFieldTag;

typedef enum {
    kNewAccount = 0,
    kOldAccountNoNick = 1,
    kOldAccountHasNick = 2
}accountSort;

#define kForgetPwdTash @"ForgetTask"

@interface ForgetViewController ()<UITextFieldDelegate>{
    int expiredInterval;
    NSTimer * timer ;
    BOOL hasChangePhone;
}
@property(strong,nonatomic)UserInfoManager* usermanager;

@property (nonatomic,assign)BOOL isYes;
@property(strong,nonatomic)NSString* uid;       //登录返回的uid
@property(strong,nonatomic)UIImage* img;


@property (weak, nonatomic) IBOutlet EFTextField *textCode;
@property (weak, nonatomic) IBOutlet UIButton *btnGetCode;
@property (weak, nonatomic) IBOutlet UIButton *btnNext;
- (IBAction)nextClicked:(id)sender;


@property(copy,nonatomic)NSString* mobileNumberString;
@property(assign,nonatomic)NSInteger counter;

@property(assign,nonatomic)BOOL isTime;    //正在倒计时
@end

@implementation ForgetViewController

- (void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];

    [self resetStatus];
    [[self navigationController] setNavigationBarHidden:NO animated:YES];
    
}


- (void)viewDidLoad {

    self.isYes = YES;
    [super viewDidLoad];
    self.usermanager = [UserInfoManager shareUserInfoManager];
    self.title = @"重置密码";
    // Do any additional setup after loading the view from its nib.
    self.phoneNum.tag = kMobilePhoneTextFieldTag;
    self.textCode.tag = kMobileCodeTextFieldTag;
    self.phoneNum.delegate = self;
    self.textCode.delegate = self;
    
    [self.btnGetCode addTarget:self action:@selector(getCode) forControlEvents:UIControlEventTouchUpInside];

    self.textCode.type = TextFieldNumber;
    self.textCode.minLength = 6;
    self.textCode.maxLength = 6;
    self.btnNext.enabled = NO;
    self.btnNext.layer.cornerRadius = 3;
    [self resetStatus];
    
    [self.phoneNum addTarget:self action:@selector(phoneNumChanged:) forControlEvents:UIControlEventEditingChanged];
    [self.textCode addTarget:self action:@selector(code:) forControlEvents:UIControlEventEditingChanged];

}
- (void)code:(UITextField *)textField{

    if (textField.text.length>6) {
        self.textCode.text = [textField.text substringToIndex:6];
    }
    if (textField.text.length>0) {
        self.btnNext.enabled = YES;
        [self.btnNext setTitleColor:Color_Bg_White forState:UIControlStateNormal];
        [self.btnNext setBackgroundColor:Color_Bg_blue];
    }else{
        
        [self.btnNext setBackgroundColor:kColorBgBtnDisabled];
        self.btnNext.enabled = NO;
        [self.btnNext setTitleColor:kColorTextBtnDisabled forState:UIControlStateNormal];
        
    }

}
-(void)resetStatus{
    self.btnGetCode.enabled = NO;
    self.isTime = NO;
    hasChangePhone = NO;
    
    self.phoneNum.text = @"";
    self.phoneNum.placeholder = @"请输入手机号";
    self.textCode.text = @"";
    self.textCode.placeholder = @"请输入验证码";
    //兼容ios7及以前版本
    self.btnGetCode.enabled = YES;
    [self.btnGetCode setTitle:@"获取验证码" forState:UIControlStateNormal];
    [self.btnGetCode setTitleColor:Color_Bg_757575 forState:UIControlStateNormal];
    [self.btnGetCode setBackgroundImage:[UIImage imageNamed:@"btn_30"] forState:UIControlStateNormal];
    [self.btnGetCode setBackgroundColor:[UIColor clearColor]];
    
    self.btnNext.enabled = NO;
    [self.btnNext setTitleColor:kColorTextBtnDisabled forState:UIControlStateNormal];
    [self.btnNext setBackgroundColor:kColorBgBtnDisabled];
    

}


- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

-(void)viewWillDisappear:(BOOL)animated{
    if (timer) {
        [timer invalidate];
    }
    [super viewWillDisappear:animated];
}


-(void)getCode{
    self.mobileNumberString = [WpCommonFunction stringRemoveAllWhiteSpace:self.phoneNum.text];
    [self.phoneNum resignFirstResponder];
    [self.textCode resignFirstResponder];
    if (self.mobileNumberString.length == 11 && [[self.mobileNumberString substringToIndex:1] isEqualToString:@"1"] ){
            //触发过期计时
            hasChangePhone = NO;
            self.counter = 60;
            DEFINED_WEAK_SELF
            
            [self.usermanager getMobileCodeWithMobile:self.mobileNumberString returnBlock:^(ReturnValue *val, QUMock *mock, QUEntity *entity) {
                SendUidMobileCodeEntity* e = (SendUidMobileCodeEntity*)entity;
                if (e!=nil && [e.result isEqualToString:@"Y"]) {
                    [WpCommonFunction showNotifyHUDAtViewBottom:_self.view withErrorMessage:@"发送成功"];
                    _self.btnGetCode.enabled = NO;
                    [_self.btnGetCode setBackgroundImage:[UIImage imageNamed:@"gray"] forState:UIControlStateNormal];
                    [_self.btnGetCode setTitleColor:kColorTextBtnDisabled forState:UIControlStateNormal];
                    timer =
                    [NSTimer scheduledTimerWithTimeInterval:1 target:self selector:@selector(showTime:) userInfo:nil repeats:YES];
                }else
                {

                    [WpCommonFunction showNotifyHUDAtViewBottom:_self.view withErrorMessage:@"发送失败"];
                    if (timer) {
                        [timer invalidate];
                    }
                     _self.btnGetCode.enabled = YES;
                    [_self.btnGetCode setTitle:@"获取验证码" forState:UIControlStateNormal];
                    [_self.btnGetCode setTitleColor:Color_Bg_757575 forState:UIControlStateNormal];
                    [_self.btnGetCode setBackgroundImage:[UIImage imageNamed:@"btn_30"] forState:UIControlStateNormal];
                    [_self.btnGetCode setBackgroundColor:[UIColor clearColor]];
                    
                }
           }];
    }
    else{
        [WpCommonFunction showNotifyHUDAtViewBottom:self.view withErrorMessage:@"请输入有效的11位手机号码"];
    }
}


-(void)showTime:(NSTimer*)time{
    if (self.counter == 0) {
        [time invalidate];
        self.isTime = NO;
        [self.btnGetCode setTitle:@"获取验证码" forState:UIControlStateNormal];
        [self.btnGetCode setTitleColor:Color_Bg_757575 forState:UIControlStateNormal];
        [self.btnGetCode setBackgroundImage:[UIImage imageNamed:@"btn_30"] forState:UIControlStateNormal];
        [self.btnGetCode setBackgroundColor:[UIColor clearColor]];
        self.btnGetCode.enabled = YES;
    }else{
        self.isTime = YES;
        self.counter--;
        //兼容ios7及以前版本
        [self.btnGetCode setTitle:[NSString stringWithFormat:@"(%lds)重新获取",(long)self.counter] forState:UIControlStateNormal];
        [self.btnGetCode setTitle:[NSString stringWithFormat:@"(%lds)重新获取",(long)self.counter] forState:UIControlStateDisabled];
        [self.btnGetCode setTitleColor:kColorTextBtnDisabled forState:UIControlStateNormal];
        //for ios7
        [self.btnGetCode setBackgroundImage:[UIImage imageNamed:@"gray"] forState:UIControlStateNormal];
        self.btnGetCode.enabled = NO;
    }
}


-(void) userValidate_ValidateFailed:(validateItem *)item
{
    self.btnGetCode.enabled = NO;

}


#pragma mark UITextFieldDelegate
-(void)phoneNumChanged:(id)sender{
    self.phoneNum.textColor = Color_Bg_222222;
    NSString* mobileNoStr = [WpCommonFunction stringRemoveAllWhiteSpace:self.phoneNum.text];

    if(mobileNoStr.length>10 && self.isTime == NO){
        self.btnGetCode.enabled = YES;
        [self.btnGetCode setTitleColor:Color_Bg_757575 forState:UIControlStateNormal];
        [self.btnGetCode setBackgroundImage:[UIImage imageNamed:@"btn_30"] forState:UIControlStateNormal];
        [self.btnGetCode setBackgroundColor:[UIColor clearColor]];

    }else{
        self.btnGetCode.enabled = NO;
        [self.btnGetCode setBackgroundImage:[UIImage imageNamed:@"gray"] forState:UIControlStateNormal];
        [self.btnGetCode setBackgroundColor:[UIColor clearColor]];
        [self.btnGetCode setTitleColor:kColorTextBtnDisabled forState:UIControlStateNormal];
    }
}

-(BOOL)textField:(UITextField *)textField shouldChangeCharactersInRange:(NSRange)range replacementString:(NSString *)string{
    NSString* mobileNoStr = [WpCommonFunction stringRemoveAllWhiteSpace:self.phoneNum.text];
    if (textField.tag == kMobilePhoneTextFieldTag) {
        
        if (mobileNoStr.length>10 && string.length>0) {
            return NO;
        }else{
            hasChangePhone = YES;
        }
        

    }
    return YES;
}

-(void)textFieldDidBeginEditing:(UITextField *)textField{
    self.textCode.textColor = Color_Bg_222222;
    if (textField.tag == kMobileCodeTextFieldTag || textField.tag == kMobilePicTextFieldTag) {
//        [self animateTextField:textField up:YES];
    }
}
-(void)textFieldDidEndEditing:(UITextField *)textField{
    if (textField.tag == kMobileCodeTextFieldTag || textField.tag == kMobilePicTextFieldTag) {
//        [self animateTextField:textField up:NO];
    }
}

-(BOOL)textFieldShouldReturn:(UITextField *)textField{
    [textField resignFirstResponder];
    return YES;
}


-(void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event{
    [self.phoneNum resignFirstResponder];
    [self.textCode resignFirstResponder];
}


- (void) animateTextField: (UITextField*) textField up: (BOOL) up

{
    
    const int movementDistance = 80; // tweak as needed
    
    const float movementDuration = 0.3f; // tweak as needed
    
    
    
    int movement = (up ? -movementDistance : movementDistance);
    
    
    //
    [UIView beginAnimations: @"anim" context: nil];
    
    [UIView setAnimationBeginsFromCurrentState: YES];
    
    [UIView setAnimationDuration: movementDuration];
    
    self.view.frame = CGRectOffset(self.view.frame, 0, movement);
    
    [UIView commitAnimations];
    
    
    
}

//#pragma mark - 获取验证码图片
//-(void)getNewPic{
//    
//    NSString *url = @"http://192.168.6.111:8116";
//    
//#if defined(WP_TEST_SERVER) // 测试环境
//    url = @"http://192.168.6.111:8116";
//#elif defined(WP_WLANTEST_SERVER) // 开发环境
//    url = @"http://192.168.6.113:8116";
//#elif defined(WP_DEVELOP_SERVER) // 开发环境
//    url = @"http://openuser.a50sina.com";
//    
//#elif defined(WP_LINKTEST_SERVER) // 联调测试环境
//    url =  @"http://180.168.176.2:8116";
//#else // 生产环境
//    url = @"http://openuser.a50sina.com";
//    
//#endif
//    
//    //暂时隐藏图片
//    //  dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
//    _img = [[UIImage alloc]init];
//    NSInteger width = 126;
//    NSInteger length = 45;
//    NSInteger font = 16;
//    NSString* UUID = [WpCommonFunction getUniqueDeviceIdentifier];
//    self.uid = UUID;
//    DEFINED_WEAK_SELF
//    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
//        NSString* imgUrl = [NSString stringWithFormat:@"%@/user/getsecuritycodePic?width=%ld&height=%ld&fontSize=%ld&UUID=%@",url,(long)width,(long)length,(long)font,UUID];
//        NSData* data = [NSData dataWithContentsOfURL:[NSURL URLWithString:imgUrl]];
//        _img = [UIImage imageWithData:data];
//        
//        if (_img) {
//            //      dispatch_async(dispatch_get_main_queue(), ^{
//            dispatch_async(dispatch_get_main_queue(), ^{
//                _self.identifyCode.hidden = NO;
//                _self.clickPic.hidden = NO;
//            });
//            //     });
//        }
//    });
//    
//}

/*
 
 #pragma mark - Navigation
 
 // In a storyboard-based application, you will often want to do a little preparation before navigation
 - (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
 // Get the new view controller using [segue destinationViewController].
 // Pass the selected object to the new view controller.
 }
 */


- (IBAction)nextClicked:(id)sender {
    
    [self.phoneNum resignFirstResponder];
    [self.textCode resignFirstResponder];
    self.phoneNum.enabled = YES;
    
    NSString* mobileNoStr = [WpCommonFunction stringRemoveAllWhiteSpace:self.phoneNum.text];
    if([self.textCode isValid] &&  mobileNoStr.length>10 && hasChangePhone==NO){
        DEFINED_WEAK_SELF
        [self.usermanager checkUidMobileCodeWithMobile:[WpCommonFunction stringRemoveAllWhiteSpace:self.phoneNum.text] Code:self.textCode.text returnBlock:^(ReturnValue *val, QUMock *mock, QUEntity *entity) {
            UidMobileCodeCheckEntity *e = (UidMobileCodeCheckEntity *)entity;
            if (e!=nil &&[e.result isEqualToString:@"Y"]) {
                UIBarButtonItem *backItem = [[UIBarButtonItem alloc] init];
                backItem.title = @"";
                _self.navigationItem.backBarButtonItem = backItem;
                ResetViewController *controller = [[ResetViewController alloc] initWithNibName:@"ResetViewController" bundle:[NSBundle mainBundle]];
                controller.pwdDelegate = self.pwdDelegate;
                controller.phoneNum = [WpCommonFunction stringRemoveAllWhiteSpace:_self.phoneNum.text];
                [_self.navigationController pushViewController:controller animated:YES];
                [_self resetStatus];
                
            }
        }];
    }else{
        [WpCommonFunction showNotifyHUDAtViewBottom:self.view withErrorMessage:@"手机号或验证码不正确"];
    }

    
}


@end
