//
//  CheckDetailBll.m
//  TPM
//
//  Created by chenyi on 16/7/27.
//  Copyright © 2016年 JYZD. All rights reserved.
//

#import "CheckDetailBll.h"
#import "DetailEntity.h"
#import "CheckDetailSection.h"
#import "CheckDetailViewController.h"
#import "DealHistoryViewController.h"
@interface CheckDetailBll ()

@property (nonatomic,strong)DetailEntity *detailEntity;
@end

@implementation CheckDetailBll

-(void)loadBll
{
    [super loadBll];
}

-(void)controllerWillAppear{
    
    [self getCheckDetail];
    
}

-(void)initQuickUI:(QUTableView *)tableView{
    
    self.pAdaptor = [QUFlatAdaptor adaptorWithTableView:tableView nibArray:@[@"CheckDetailSection"] delegate:self];
    [self.pAdaptor.pSources addEntity:[QUEntity entity] withSection:[CheckBuySection class]];
    [self.pAdaptor.pSources addEntity:[QUEntity entity] withSection:[CheckDetailSection class]];
    [self.pAdaptor.pSources addEntity:[QUEntity entity] withSection:[CheckSellSection class]];
    [self.pAdaptor notifyChanged];
}

-(void)getCheckDetail{

    CheckDetailViewController *controller = (CheckDetailViewController *)self.controller;
    [[ViewControllerManager sharedManager] showWaitView:self.controller.view];
    DEFINED_WEAK_SELF
    [[ProductsManager shareProductsManager]getCheckDetailWithP_id:controller.p_id AndP_type:@"" Block:^(ReturnValue *val, QUMock *mock, QUEntity *entity) {
        [[ViewControllerManager sharedManager] hideWaitView];
        if (val.result && [entity isKindOfClass:[DetailEntity class]]) {
           
            DetailEntity *e = (DetailEntity *)entity;
            _self.detailEntity = e;
            
            [_self.pAdaptor notifyChanged];
        }
    }];
}

-(void)QUAdaptor:(QUAdaptor *)adaptor forSection:(QUSection *)section forEntity:(QUEntity *)entity{

    NSDateFormatter *formatter = [[NSDateFormatter alloc] init];
    [formatter setDateStyle:NSDateFormatterMediumStyle];
    [formatter setTimeStyle:NSDateFormatterShortStyle];
    [formatter setDateFormat:@"MM-dd"]; // ----------设置你想要的格式,hh与HH的区别:分别表示12小时制,24小时
    
    NSNumberFormatter *numberFormatter = [[NSNumberFormatter alloc] init];
    [numberFormatter setPositiveFormat:@"###,##0.00;"];
    
    if ([section isKindOfClass:[CheckBuySection class]]) {
        CheckBuySection *s = (CheckBuySection *)section;
        if (![self.detailEntity.buy_date isEqualToString:@"0"]&&self.detailEntity.buy_date) {
            NSDate *temp = [NSDate dateWithTimeIntervalSince1970:[self.detailEntity.buy_date integerValue]];
            NSString* dateStr = [formatter stringFromDate:temp];
            s.lblBuyDate.text = [NSString stringWithFormat:@"开仓日期 %@",dateStr];
        }
        
        s.lblBuyTimes.text = [NSString stringWithFormat:@"策略次数%d次",self.detailEntity.buy_times.intValue];
        NSNumber *buyFund = [NSNumber numberWithDouble:[self.detailEntity.buy_fund doubleValue]];
        s.lblBuyFund.text = [NSString stringWithFormat:@"%@",[numberFormatter stringFromNumber:buyFund]];
        s.lblBuyDealAvgPrice.text = [NSString stringWithFormat:@"%.2f元",self.detailEntity.buy_deal_avg_price.floatValue];
        s.lblBuyAmount.text = [NSString stringWithFormat:@"%d股",self.detailEntity.buy_amount.intValue];
    }
    if ([section isKindOfClass:[CheckDetailSection class]]) {
        CheckDetailSection *s = (CheckDetailSection *)section;
        
        if (![self.detailEntity.apply_sell_date isEqualToString:@"0"]&&self.detailEntity.apply_sell_date) {
            NSDate *applySellDate = [NSDate dateWithTimeIntervalSince1970:self.detailEntity.apply_sell_date.integerValue];
            NSString *applySell = [formatter stringFromDate:applySellDate];
            s.lblApplySellDate.text = [NSString stringWithFormat:@"通知日期 %@",applySell];
        }
        if ([self.detailEntity.state isEqualToString:@"1"]) {
            s.lblSellProfitState.text = @"通知平仓日收盘浮盈";
        }else if ([self.detailEntity.state isEqualToString:@"2"]){
            
            s.lblSellProfitState.text = @"到期通知平仓日收盘浮盈";
        }
        s.lblApplySellProfitRate.text = [NSString stringWithFormat:@"%.2f%%",self.detailEntity.apply_sell_profit_rate.floatValue];
        s.lblYClose.text = [NSString stringWithFormat:@"%.2f元",self.detailEntity.y_close.floatValue];
        s.lblApplySellDays.text = [NSString stringWithFormat:@"第%d交易日",self.detailEntity.apply_sell_days.intValue];
    }
    if ([section isKindOfClass:[CheckSellSection class]]) {
        CheckSellSection *s = (CheckSellSection *)section;
        
        if (![self.detailEntity.sell_date isEqualToString:@"0"]&&self.detailEntity.sell_date) {
            NSDate *sellDate = [NSDate dateWithTimeIntervalSince1970:self.detailEntity.sell_date.integerValue];
            NSString *sellStr = [formatter stringFromDate:sellDate];
            s.lblSellDate.text = [NSString stringWithFormat:@"平仓日期 %@",sellStr];
        }
        if ([self.detailEntity.state isEqualToString:@"1"]) {
            s.lblSellState.text = @"平仓策略执行结果";
        }else if ([self.detailEntity.state isEqualToString:@"2"]){
            
            s.lblSellState.text = @"到期平仓策略执行结果";
        }
        s.lblSellTimes.text = [NSString stringWithFormat:@"策略次数%d次",self.detailEntity.sell_times.intValue];
        NSNumber *sellFund = [NSNumber numberWithDouble:[self.detailEntity.sell_fund doubleValue]];
        s.lblSellFund.text = [NSString stringWithFormat:@"%@",[numberFormatter stringFromNumber:sellFund]];
        if (self.detailEntity.sell_deal_avg_price) {
            
            s.lblSellDealAvgPrice.text = [NSString stringWithFormat:@"%.2f元",self.detailEntity.sell_deal_avg_price.floatValue];
            s.lblSellDealAvgPrice.textColor = Color_Bg_222222;
        }
        if (self.detailEntity.sell_amount) {
            s.lblSellAmount.text = [NSString stringWithFormat:@"%d股",self.detailEntity.sell_amount.intValue];
            s.lblSellAmount.textColor = Color_Bg_222222;
        }
    }

}


-(void)QUAdaptor:(QUAdaptor *)adaptor selectedSection:(QUSection *)section entity:(QUEntity *)entity{

    DealHistoryViewController *controller = [[DealHistoryViewController alloc]initWithNibName:@"DealHistoryViewController" bundle:nil];
    controller.p_id = self.detailEntity.ID;
    if ([section isKindOfClass:[CheckBuySection class]]) {
        
        controller.historyTitle = @"建仓策略明细";
        controller.type = @"1";
        [self.controller.navigationController pushViewController:controller animated:YES];
    }
    if ([section isKindOfClass:[CheckSellSection class]]) {
        controller.historyTitle = @"平仓策略明细";
        controller.type = @"2";
        [self.controller.navigationController pushViewController:controller animated:YES];
    }
    
}
@end
