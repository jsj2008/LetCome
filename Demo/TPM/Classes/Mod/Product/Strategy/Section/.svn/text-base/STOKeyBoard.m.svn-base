//
//  STOKeyBoard.m
//  STO
//
//  Created by tongshangren on 16/7/7.
//  Copyright © 2016年 JYZD. All rights reserved.
//

#import "STOKeyBoard.h"
#define kFilterNumber @"1234567890."

@implementation STOKeyBoard
static STOKeyBoard *_keyBoard = nil;
+(instancetype)keyBoardForTextField:(UITextField*)textField{
    int winwidth=[UIScreen mainScreen].bounds.size.width;
    int winheight=[UIScreen mainScreen].bounds.size.height;
    NSArray *nibContents = [[NSBundle mainBundle] loadNibNamed:@"STOKeyBoard" owner:nil options:nil];
    
    _keyBoard=[nibContents objectAtIndex:0];
    _keyBoard.frame=CGRectMake(0, 0, winwidth, winheight);
    _keyBoard.textfield=textField;

    return _keyBoard;
}

- (IBAction)btnClose:(id)sender {
    [self filterNumber];
    [self closeKeyBoard];
}

-(void)closeKeyBoard{
    self.textfield.text=[self.textfield.text stringByReplacingOccurrencesOfString:@"︳" withString:@""];
    
    [self.keyBoardDelegate closeFunc];
    [self removeFromSuperview];
}

- (IBAction)click1:(id)sender {
    self.textfield.text=[self.textfield.text stringByAppendingString:@"1"];
    [self filterNumber];
}

- (IBAction)click2:(id)sender {
    self.textfield.text=[self.textfield.text stringByAppendingString:@"2"];
    [self filterNumber];
}

- (IBAction)click3:(id)sender {
    self.textfield.text=[self.textfield.text stringByAppendingString:@"3"];
    [self filterNumber];
}

- (IBAction)click4:(id)sender {
    self.textfield.text=[self.textfield.text stringByAppendingString:@"4"];
    [self filterNumber];
}

- (IBAction)click5:(id)sender {
    self.textfield.text=[self.textfield.text stringByAppendingString:@"5"];
    [self filterNumber];
}

- (IBAction)click6:(id)sender {
    self.textfield.text=[self.textfield.text stringByAppendingString:@"6"];
    [self filterNumber];
}

- (IBAction)click7:(id)sender {
    self.textfield.text=[self.textfield.text stringByAppendingString:@"7"];
    [self filterNumber];
}

- (IBAction)click8:(id)sender {
    self.textfield.text=[self.textfield.text stringByAppendingString:@"8"];
    [self filterNumber];
}

- (IBAction)click9:(id)sender {
    self.textfield.text=[self.textfield.text stringByAppendingString:@"9"];
    [self filterNumber];
}

- (IBAction)click0:(id)sender {
    self.textfield.text=[self.textfield.text stringByAppendingString:@"00"];
    [self filterNumber];
}


- (IBAction)btnLeftClick:(id)sender {
    self.textfield.text=[self.textfield.text stringByAppendingString:self.btnLeft.titleLabel.text];
    [self filterNumber];
}

- (IBAction)btnRightClick:(id)sender {
    [self filterNumber];
    [self.keyBoardDelegate rightFunc];
}

- (IBAction)clickDelete:(id)sender {
    self.textfield.text=[self.textfield.text stringByReplacingOccurrencesOfString:@"︳" withString:@""];
    [self deleteLastWord];
    [self filterNumber];
}
- (IBAction)clickConfirm:(id)sender {
//    [self filterNumber];
    self.textfield.text=[self.textfield.text stringByReplacingOccurrencesOfString:@"︳" withString:@""];
    [self.keyBoardDelegate confirmFunc];
}


//过滤只能数字
-(void)filterNumber{   
    //2.最多允许输入两位小数
    NSRange strRange =[self.textfield.text rangeOfString:@"."];
    if(strRange.location!=NSIntegerMax) // 有小数点
    {
        NSString *strPrice = [self.textfield.text substringFromIndex:strRange.location + 1];
        
        if (strPrice.length > 3 || [strPrice rangeOfString:@"."].length) {
            [self deleteLastWord];
        }
    }
    NSString * str = self.textfield.text;
    NSMutableString *newstr = [NSMutableString string];
    for(int i=0;str!=nil && i<str.length;++i){
        NSString* find = [str substringWithRange:NSMakeRange(i, 1)];
        NSRange range = [kFilterNumber rangeOfString:find];
        if (range.location != NSNotFound&&newstr.length<10) {
            [newstr appendString:find];
        }
    }
    
//    NSString *resultStr=(NSString *)newstr;
//    
//    if (resultStr.length>8) {
//        resultStr=@"1";
//    }
    
    
    
    [self.keyBoardDelegate textChangeTo:newstr];


        [newstr appendString:@"︳"];
        self.textfield.text = newstr;
    if ([self.keyBoardDelegate respondsToSelector:@selector(textHasChanged)]) {
        [self.keyBoardDelegate textHasChanged];
    }

}


//删除
-(void)deleteLastWord{
    if (self.textfield.text.length) {
        NSString * newString = [self.textfield.text substringWithRange:NSMakeRange(0, [self.textfield.text length] - 1)];
        self.textfield.text=newString;
    }
}
@end
