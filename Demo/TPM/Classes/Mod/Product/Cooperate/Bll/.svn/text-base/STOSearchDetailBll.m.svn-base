//
//  STOSearchDetailBll.m
//  TPM
//
//  Created by tongshangren on 16/7/28.
//  Copyright © 2016年 JYZD. All rights reserved.
//

#import "STOSearchDetailBll.h"
#import "TPMSearchDetailSection.h"
#import "TPMDetailViewController.h"
#import "STOSearchViewController.h"
#import "PolicyListEntity.h"

@interface STOSearchDetailBll()
{
__weak STOSearchViewController *_searchController;
}
@end



@implementation STOSearchDetailBll


-(void)loadBll{
    [super loadBll];
    STOSearchViewController *c = (STOSearchViewController *)self.controller;
    _searchController = c;//获取控制器，便于此bll使用
}


-(void)initQuickUI:(QUTableView *)tableView{

    self.pAdaptor = [QUFlatAdaptor adaptorWithTableView:tableView nibArray:@[@"TPMSearchDetailSection"] delegate:self backGroundClr:[UIColor colorWithRed:244.0/255.0 green:244.0/255.0 blue:244.0/255.0 alpha:1.0]];
   
}


-(void)getData{
    DEFINED_WEAK_SELF
    [[ProductsManager shareProductsManager]getPolicyListByCode:_searchController.search.text startID:@"0" limit:@"20" block:^(ReturnValue *val, QUMock *mock, QUEntity *entity) {
        if ([entity isKindOfClass:[PolicyListEntity class]]) {
            PolicyListEntity *e=(PolicyListEntity *)entity;
            if (e.records.count) {
                QUJsonParse *jsonParse = [[QUJsonParse alloc]init];
                for (NSArray *array in e.records) {
                    
                    for (NSDictionary *dic in array) {
                        
                        
                        NSData * jsonData = [NSJSONSerialization dataWithJSONObject:dic options:kNilOptions error:nil];
                        
                        NSString *jsStr=[[NSString alloc] initWithData:jsonData encoding:NSUTF8StringEncoding];
                        
                        PolicyListRecordsEntity* e =[jsonParse objFromString:jsStr withClass:[PolicyListRecordsEntity class]];
                        [_self.pAdaptor.pSources addEntity:e withSection:[TPMSearchDetailSection class]];
                    }
                    [_self.pAdaptor.pSources addEntity:[QUEntity entity] withSection:[TPMSeparateSection class]];
                }
                [_self.pAdaptor notifyChanged];
            }

        }

    }];

}







-(void)QUAdaptor:(QUAdaptor *)adaptor forSection:(QUSection *)section forEntity:(QUEntity *)entity{
    if ([section isKindOfClass:[TPMSearchDetailSection class]]&&[entity isKindOfClass:[PolicyListRecordsEntity class]]) {
        TPMSearchDetailSection *s=(TPMSearchDetailSection *)section;
        PolicyListRecordsEntity *e=(PolicyListRecordsEntity *)entity;
        s.btnEnter.policyEntity=e;
        s.lblUserID.text=e.investor_code;
        s.lblFund.text=[NSString stringWithFormat:@"%d万",[e.fund intValue]/10000];
        s.lblStockName.text=e.stock_name;
        s.lblTimeLeft.text=e.end_time_str;

        switch ([e.fund_state intValue]) {
            case 0:
                s.lblState.layer.borderColor=[[UIColor colorWithRed:190.0/255.0 green:190.0/255.0 blue:190.0/255.0 alpha:1.0]CGColor];
                s.lblState.text=@"售罄";
                break;
            case 1:
                s.lblState.layer.borderColor=[[UIColor colorWithRed:255.0/255.0 green:120.0/255.0 blue:20.0/255.0 alpha:1.0]CGColor];
                s.lblState.text=@"少量";
                break;
            case 2:
                s.lblState.layer.borderColor=[[UIColor colorWithRed:80.0/255.0 green:140.0/255.0 blue:240.0/255.0 alpha:1.0]CGColor];
                s.lblState.text=@"充足";
                break;
            default:
                break;
        }
        
        switch ([e.state intValue]) {
            case 0:
                [s.btnStrategy setTitleColor:Color_Bg_757575 forState:UIControlStateNormal];
                s.btnStrategy.backgroundColor=[UIColor colorWithRed:224.0/255.0 green:224.0/255.0 blue:224.0/255.0 alpha:1.0];
                break;
            case 1:
                [s.btnStrategy setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
                s.btnStrategy.backgroundColor=[UIColor colorWithRed:80.0/255.0 green:140.0/255.0 blue:240.0/255.0 alpha:1.0];
                break;
            default:
                break;
        }

        [s.btnEnter addTarget:self action:@selector(go2detail:) forControlEvents:UIControlEventTouchUpInside];
    }
}




-(void)go2detail:(TPMSelectBtn *)button{
    if ([button.policyEntity.state intValue]==1) {
        TPMDetailViewController *detailVC=[[TPMDetailViewController alloc]initWithNibName:@"TPMDetailViewController" bundle:nil];
        detailVC.policyEntity=button.policyEntity;
        [self.controller.navigationController pushViewController:detailVC animated:YES];
    }
}

@end
