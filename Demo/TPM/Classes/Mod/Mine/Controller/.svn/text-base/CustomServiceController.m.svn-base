//
//  CustomServiceController.m
//  A50
//
//  Created by tongshangren on 15/11/3.
//  Copyright © 2015年 JYZD. All rights reserved.
//

#import "CustomServiceController.h"
#import "MyWebViewController.h"
#import "CustomerServiceEntity.h"
#import "UIImageView+WebCache.h"
#import "UIBarButtonItem+YL.h"
#import "SetListSection.h"
#import "SetListEntity.h"

@interface CustomServiceController ()

@property (strong, nonatomic) NSString *url;

@end

@implementation CustomServiceController
- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.title=@"我的客服";
    
    self.imgFace.layer.masksToBounds=YES;
    self.imgFace.layer.cornerRadius=45;
    [self.backBtn addTarget:self action:@selector(back) forControlEvents:UIControlEventTouchUpInside];
//    self.navigationItem.leftBarButtonItem = [UIBarButtonItem buttonItemWithIcon:@"back_white" highlightedIcon:@"back_white" target:self action:@selector(back)];

    self.url=[NSString stringWithFormat:@"%@%@%@",[ConfigManager shareConfigManager].customerServiceAddress,[[UserInfoManager shareUserInfoManager] getSessionID],@"&type=1"];
    
    [self getCustomerServiceInfo];
}


-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    // 显示导航条
    [[self navigationController] setNavigationBarHidden:YES animated:NO];

    
}

-(void)initQuickUI{

    self.pAdaptor = [QUFlatAdaptor adaptorWithTableView:self.myTab nibArray:@[@"SetListSection"] delegate:self];
    
    QUEntity* empty=[QUEntity entityWithLine:QU_FLAT_COLOR_LINE];
    [self.pAdaptor.pSources addEntity:empty withSection:[SetEmptyListSection class]];
    
    SetListEntity* entity1 = [SetListEntity entity];
    entity1.sectionList = @"在线客服";
    entity1.tag = 1;
    entity1.selectionStyle = UITableViewCellSelectionStyleGray;
    entity1.lineBottomColor = QU_FLAT_COLOR_LINE;
    entity1.pIndentBottomLevel = 1;
    entity1.selectedBgColor = QU_FLAT_COLOR_CELL_BG_SELECTED;
    [self.pAdaptor.pSources addEntity:entity1 withSection:[SetSimpleListSection class]];
    
    SetListEntity* entity2 = [SetListEntity entity];
    entity2.sectionList = @"意见反馈";
    entity2.tag = 2;
    entity2.selectionStyle = UITableViewCellSelectionStyleGray;
    entity2.selectedBgColor = QU_FLAT_COLOR_CELL_BG_SELECTED;
    [self.pAdaptor.pSources addEntity:entity2 withSection:[SetSimpleListSection class]];

     empty = [QUEntity entityWithLineTop:QU_FLAT_COLOR_LINE lineBottom:QU_FLAT_COLOR_LINE];
    [self.pAdaptor.pSources addEntity:empty withSection:[SetEmptyListSection class]];
    
    SetListEntity* entity3 = [SetListEntity entity];
    entity3.sectionList = @"常见问题";
    entity3.tag = 3;
    entity3.selectionStyle = UITableViewCellSelectionStyleGray;
    entity3.lineBottomColor = QU_FLAT_COLOR_LINE;
    entity3.pIndentBottomLevel = 1;
    entity3.selectedBgColor = QU_FLAT_COLOR_CELL_BG_SELECTED;
    [self.pAdaptor.pSources addEntity:entity3 withSection:[SetSimpleListSection class]];
    
    SetListEntity* entity4 = [SetListEntity entity];
    entity4.sectionList = @"新手引导";
    entity4.tag = 4;
    entity4.selectionStyle = UITableViewCellSelectionStyleGray;
    entity4.selectedBgColor = QU_FLAT_COLOR_CELL_BG_SELECTED;
    [self.pAdaptor.pSources addEntity:entity4 withSection:[SetSimpleListSection class]];
    empty = [QUEntity entityWithLineTop:QU_FLAT_COLOR_LINE lineBottom:nil];
    [self.pAdaptor.pSources addEntity:empty withSection:[SetEmptyListSection class]];

     [self.pAdaptor notifyChanged];
    
}

-(void)QUAdaptor:(QUAdaptor *)adaptor forSection:(QUSection *)section forEntity:(QUEntity *)entity{
    
    if ([section isKindOfClass:[SetSimpleListSection class]]) {
        SetListEntity* e = (SetListEntity*)entity;
        SetSimpleListSection* s = (SetSimpleListSection*)section;
        s.title.text = e.sectionList;
    }
}

-(void)QUAdaptor:(QUAdaptor *)adaptor selectedSection:(QUSection *)section entity:(QUEntity *)entity{


    if (entity.tag == 1) {
        
        [self goToMyCustomerService];
    }
    if (entity.tag == 2) {
        
        [self goTofeedback];
    }
    if (entity.tag == 3) {
        
        [self goToQuestionWebView];
    }
    if (entity.tag == 4) {
        
        [self goToNoviceGuidanceWebView];
    }
}

- (void)back {
    [self.navigationController popViewControllerAnimated:YES];
}


- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}


-(void)getCustomerServiceInfo{
    
    UserInfoManager *manager=[UserInfoManager shareUserInfoManager];
    DEFINED_WEAK_SELF
    [manager getCustomerServiceInfoWithReturnBlock:^(ReturnValue *val, QUMock *mock, QUEntity *entity) {
        if ([entity isKindOfClass:[CustomerServiceEntity class]]) {
            
            CustomerServiceEntity *e=(CustomerServiceEntity *)entity;
            _self.lblServiceNickname.text=e.nickname;
            _self.lblDesc.text=e.desc;
            _self.url=e.url;            
//            e.pic = @"http://www.baidu.com/img/bdlogo.png";
            [_self.imgFace sd_setImageWithURL:[NSURL URLWithString:e.pic] placeholderImage:[UIImage imageNamed:@"mine_serviceFace"]];
            
        }
    }];
}


-(void)goTofeedback{
    
    
    MyWebViewController *controller = [[MyWebViewController alloc]initWithNibName:@"MyWebViewController" bundle:nil];
    
    controller.url = [NSString stringWithFormat:@"%@/feedback/index",[ConfigManager shareConfigManager].h5Url];
    controller.isBack2History = NO;
    controller.title= @"意见反馈";
    controller.method=@"GET";
    [self.navigationController pushViewController:controller animated:YES];

}


-(void)goToQuestionWebView{
    
    
    MyWebViewController* controller = [[MyWebViewController alloc]initWithNibName:@"MyWebViewController" bundle:nil];
    controller.url = [NSString stringWithFormat:@"%@/message/commonQuestion?&session_id=%@",[ConfigManager shareConfigManager].h5Url,[[UserInfoManager shareUserInfoManager] getSessionID]];
    controller.title = @"常见问题";
    [self.navigationController pushViewController:controller animated:YES];

}


-(void)goToMyCustomerService{

    MyWebViewController *controller = [[MyWebViewController alloc]initWithNibName:@"MyWebViewController" bundle:nil];
    controller.url=self.url;
    NSRange str = [controller.url rangeOfString:@"?"];
    if (str.location!=NSIntegerMax) {
        controller.url = [NSString stringWithFormat:@"%@&session_id=%@",controller.url,[[UserInfoManager shareUserInfoManager] getSessionID]];
    }else{
        controller.url = [NSString stringWithFormat:@"%@?session_id=%@",controller.url,[[UserInfoManager shareUserInfoManager] getSessionID]];
    }
    
    controller.title= @"在线客服";
    [self.navigationController pushViewController:controller animated:YES];

}

//新手指导
-(void)goToNoviceGuidanceWebView{

    MyWebViewController* controller = [[MyWebViewController alloc]initWithNibName:@"MyWebViewController" bundle:nil];
    controller.url = [NSString stringWithFormat:@"%@/message/guide?&session_id=%@",[ConfigManager shareConfigManager].h5Url,[[UserInfoManager shareUserInfoManager] getSessionID]];
    controller.title = @"新手引导";
    [self.navigationController pushViewController:controller animated:YES];
}

@end
