//
//  GesturePwdViewController.m
//  QianFangGuJie
//
//  Created by  rjt on 15/4/16.
//  Copyright (c) 2015年 余龙. All rights reserved.
//

#import "GesturePwdViewController.h"
#import "GestureVC.h"
#import "GestureUtil.h"
#import "Login2ViewController.h"


@interface GesturePwdViewController ()<UITableViewDataSource,UITableViewDelegate,UIAlertViewDelegate,PasswordViewControllerDelegate>{
    UISwitch * sw;
}
@property (weak, nonatomic) IBOutlet UITableView *table;

@end

@implementation GesturePwdViewController

-(void) loginCallback:(BOOL)suc{
    if (suc) {
        sw.on = NO;
        [GestureUtil removePassword];
    }
}

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.
    self.table.dataSource = self;
    self.table.delegate = self;
    
    self.table.backgroundColor = QU_FLAT_COLOR_TABLE_BG;
    self.title = @"手势密码";
    
    
}

-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:YES];
    [self.table reloadData];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
 #pragma mark - Navigation
 
 // In a storyboard-based application, you will often want to do a little preparation before navigation
 - (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
 // Get the new view controller using [segue destinationViewController].
 // Pass the selected object to the new view controller.
 }
 */

#pragma mark - UITableDataSource
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView;{
    if ([GestureUtil isPwdExisted]) {
        return 2;
    }else{
        return 1;
    }
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    static NSString* cellIdentifyer =@"GesturePwdSettingCell";
    UITableViewCell* cell = [tableView dequeueReusableCellWithIdentifier:cellIdentifyer];
    if (cell == nil) {
        cell = [(UITableViewCell*)[UITableViewCell alloc]initWithStyle:UITableViewCellStyleDefault reuseIdentifier:cellIdentifyer];
    }
    if (indexPath.section == 0) {
        
        cell.textLabel.text = @"手势密码";
        
        
        sw=[[UISwitch alloc]init];
        [sw addTarget:self action:@selector(switchValueChange:) forControlEvents:UIControlEventValueChanged];
        //判断是不是已经设置了密码
        sw.on = [GestureUtil isPwdExisted];
        cell.accessoryView=sw;
        
    }else if(indexPath.section == 1 && [GestureUtil isPwdExisted]){
        if (indexPath.row == 0 ) {
            cell.textLabel.text = @"修改手势密码";
            cell.accessoryType = UITableViewCellAccessoryDisclosureIndicator;
        }
        else  if (indexPath.row == 1 ) {
            cell.textLabel.text = @"忘记手势密码";
            cell.accessoryType = UITableViewCellAccessoryDisclosureIndicator;
        }
        
    }
    cell.textLabel.font = [UIFont systemFontOfSize:16];
    
    cell.textColor = [UIColor colorWithRed:66/255.0 green:66/255.0 blue:66/255.0 alpha:1.0];

    return cell;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section==0) {
        return 1;
    }else if(section == 1){
        return 2;
    }
    return 0;
}

-(NSString *)tableView:(UITableView *)tableView titleForHeaderInSection:(NSInteger)section{
    return @"";
}

-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return 20;
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return 53.5f;
}

-(void)setCallback{
    sw.on =  [GestureUtil isPwdExisted];
}

-(void)switchValueChange:(id)sender{
    GestureVC *controller = [[GestureVC alloc] initWithNibName:@"GestureView" bundle:[NSBundle mainBundle]];
    if ([sw isOn]) {
        controller.runMode = GestureView_Mode_Active;
        controller.parent = self;
    }else{
        controller.runMode = GestureView_Mode_Forget;
        controller.parent = self;
    }
    [self presentViewController:controller animated:YES completion:nil];
}

-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    if (![sw isOn] && indexPath.section != 0) {
        [WpCommonFunction showNotifyHUDAtViewBottom:self.view withErrorMessage:@"请先设置手势密码"];
    }else{
        if(indexPath.section == 1 && indexPath.row == 0){
            GestureVC *controller = [[GestureVC alloc] initWithNibName:@"GestureView" bundle:[NSBundle mainBundle]];
            controller.runMode = GestureView_Mode_Reset;
            controller.parent = self;
            [self presentViewController:controller animated:YES completion:nil];
        }else if(indexPath.section == 1 && indexPath.row == 1){
            UIAlertView* alert = [[UIAlertView alloc] initWithTitle:@"提示" message:@"忘记手势密码，需要验证登录密码" delegate:nil cancelButtonTitle:@"取消" otherButtonTitles:@"确定",nil];
            alert.delegate = self;
            [alert show];
            //sw.on = NO;
            
        }
        
    }
    [tableView deselectRowAtIndexPath:indexPath animated:NO]; //取消选中
}

#pragma marks - UIAlertViewDelegate
-(void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex{
    if (alertView.cancelButtonIndex != buttonIndex) {
        //点击了确定
        Login2ViewController* controller = [[Login2ViewController alloc]initWithNibName:@"Login2ViewController" bundle:nil];
        controller.mark = @"gesture";
        controller.gesture = self;
        controller.pwdDelegate = self;
        [self presentViewController:controller animated:YES completion:nil];
    }
}

#pragma marks - 代理
-(void)pwdViewControllerSwitchForgetPwd:(UIViewController*)vc{
    [[ViewControllerManager sharedManager] dismissAllController:self.presentedViewController];
    [AppUtil exitAccountGo2Forget:NO];
}


@end
