//
//  AdvViewController.m
//  QianFangGuJie
//
//  Created by  rjt on 15/4/14.
//  Copyright (c) 2015年 余龙. All rights reserved.
//

#import "H5ViewController.h"
#import "UIWebView+Clean.h"
#import "CPBAmountViewController.h"


@interface H5ViewController ()<UIWebViewDelegate>

- (IBAction)closeClicked:(id)sender;

@end

@implementation H5ViewController
{
    MyViewController *controller;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.
    self.webView.delegate = self;
    
    [self checkUrl];
    
    controller=[MyViewController alloc];
    int winwidth=[UIScreen mainScreen].bounds.size.width;
    int winheight=[UIScreen mainScreen].bounds.size.height;
    controller.view.frame=CGRectMake(0, 0, winwidth, winheight);
   
    [[UIApplication sharedApplication] setStatusBarStyle:UIStatusBarStyleDefault];
    
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}
-(void)viewWillAppear:(BOOL)animated{
    
    [[UIApplication sharedApplication] setStatusBarStyle:UIStatusBarStyleDefault];
    NSString *str = self.url;
    str = [str stringByReplacingOccurrencesOfString:@" " withString:@"%20"];
    if ([[self.method uppercaseString] isEqualToString:@"GET"]) {
        NSURL *url = [NSURL URLWithString:str];
        NSURLRequest *request = [NSURLRequest requestWithURL:url];
        [self.webView loadRequest:request];
    }else{
        NSArray *arr = [str componentsSeparatedByString:@"?"];
        NSURL *url = [NSURL URLWithString:arr[0]];
        NSMutableURLRequest *postReq = [[NSMutableURLRequest alloc]initWithURL: url];
        [postReq setHTTPMethod: @"POST"];
        if (arr.count>1) {
            [postReq setHTTPBody: [arr[1] dataUsingEncoding: NSUTF8StringEncoding]];
        }
        [self.webView loadRequest:postReq];
    }

    
    
}

-(void)checkUrl{
    NSString *str ;
    if ([self.url hasPrefix:@"http"]||[self.url hasPrefix:@"https"]) {
        str = [NSString stringWithFormat:@"%@",self.url];
    }else{
        str = [NSString stringWithFormat:@"http://%@",self.url];
    }
    
    NSRange range = [self.url rangeOfString:@"session_id"];
    if ([[UserInfoManager shareUserInfoManager] getSessionID]&&range.location==NSIntegerMax) {
        range = [self.url rangeOfString:@"?"];
        if (range.location!=NSIntegerMax) {
            str = [NSString stringWithFormat:@"%@&session_id=%@",str,[[UserInfoManager shareUserInfoManager] getSessionID]];
        }else{
            str = [NSString stringWithFormat:@"%@?session_id=%@",str,[[UserInfoManager shareUserInfoManager] getSessionID]];
        }
    }
    self.url = str;
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

- (IBAction)closeClicked:(id)sender {
    [self.webView cleanForDealloc];
    [self dismissViewControllerAnimated:YES completion:^{
        if ([self.parent respondsToSelector:@selector(presentHasDismissed:)]) {
            [self.parent presentHasDismissed:nil];
        }
    }];
}

- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType {
   
    if ([H5ViewController isClosed:request]) {
        [self closeClicked:nil];
        return NO;
    }
    if ([H5ViewController isSessionTimeout:request]) {
//        [self closeClicked:nil];
        [self.webView cleanForDealloc];
        [self dismissViewControllerAnimated:NO completion:nil];
        [AppUtil switchIndex:NO];
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(.7f * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            [AppMock launchSessionTimeoutViewController:[ViewControllerManager sharedManager].currentController1];       //跳转登陆界面2
        });
        return NO;
    }
    return YES;
}


+(BOOL)isClosed:(NSURLRequest *)request{
    NSString *requestString = [[request URL] absoluteString];
    NSString *codeString = [requestString stringByReplacingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
    NSArray *components = [codeString componentsSeparatedByString:@":"];
    if ([components count] > 1 && [(NSString *)[components objectAtIndex:0] isEqualToString:@"cpb"]) {
        if([(NSString *)[components objectAtIndex:1] isEqualToString:@"N"])
        {
            NSString* reason = [components objectAtIndex:3];
            [WpCommonFunction messageBoxWithMessage:reason];
            //[[NSNotificationCenter defaultCenter]postNotificationName:kBindCPBFail object:nil];
            return YES;
        }
        else
        {
            //[[NSNotificationCenter defaultCenter]postNotificationName:kBindCPBSuccess object:nil];
            return YES;
        }
    }
    
    if ([components count] > 1 && [(NSString *)[components objectAtIndex:0] isEqualToString:@"ios"]) {
        if ([(NSString *)[components objectAtIndex:1] isEqualToString:@"//type@backhome"] || [(NSString *)[components objectAtIndex:1] isEqualToString:@"//request@regSuccess"] ||  [(NSString *)[components objectAtIndex:1] isEqualToString:@"//type@a50_authenticationback2app"]) {
           return YES;
        }
    }
    return NO;
}

+(BOOL)isSessionTimeout:(NSURLRequest *)request{
    NSString *requestString = [[request URL] absoluteString];
    NSString *codeString = [requestString stringByReplacingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
    NSArray *components = [codeString componentsSeparatedByString:@":"];
    
    if ([components count] > 1 && [(NSString *)[components objectAtIndex:0] isEqualToString:@"ios"]) {
        if ([(NSString *)[components objectAtIndex:1] isEqualToString:@"//type@backlogin"]) {
            return YES;
        }
    }
    return NO;
}


-(NSString*)urlStringResolve:(NSString *)urlstring
{
    NSArray *components = [urlstring componentsSeparatedByString:@"@"];
    
    return (NSString *)[components objectAtIndex:1];
}






-(void)dealloc{
    [self.webView cleanForDealloc];
    NSLog(@"%@ has dealloc",self.class);
}
@end
